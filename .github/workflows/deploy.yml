name: Deploy SDK (Improved)

on:
  # 1. Main ë¸Œëœì¹˜ ë° CI ë¸Œëœì¹˜ push/merge ì‹œ ìë™ ë°°í¬
  push:
    branches:
      - main
      - 'ci/**'
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - '!.github/workflows/**'
  
  # 2. ìˆ˜ë™ ë°°í¬ (ê°€ì¥ ìœ ì—°í•¨)
  workflow_dispatch:
    inputs:
      deploy_type:
        description: 'ë°°í¬ íƒ€ì…'
        required: true
        type: choice
        options:
          - release
          - snapshot
          - both
        default: release
      
      version_bump_type:
        description: 'ë²„ì „ ë²”í”„ íƒ€ì…'
        required: false
        type: choice
        options:
          - none
          - fix
          - release
          - manual
        default: none
      
      manual_versions:
        description: 'ìˆ˜ë™ ë²„ì „ ì„¤ì • (ì˜ˆ: BOM=1.2.0,APPKIT=1.2.1)'
        required: false
        type: string
        default: ''
      
      target_modules:
        description: 'ë°°í¬í•  ëª¨ë“ˆ (ë¹„ì–´ìˆìœ¼ë©´ ì „ì²´)'
        required: false
        type: string
        default: ''
        
      dry_run:
        description: 'í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ì‹¤ì œ ë°°í¬ ì•ˆí•¨)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: write

jobs:
  # SonarQube ë¶„ì„
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    if: github.event.inputs.deploy_type == 'release' || github.event_name == 'push'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
  # ë³€ê²½ì‚¬í•­ ê°ì§€
  detect-changes:
    name: Detect Changes
    needs: [sonarqube]
    if: always() && (needs.sonarqube.result == 'success' || needs.sonarqube.result == 'skipped')
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.changes.outputs.has_changes }}
      changed_modules: ${{ steps.changes.outputs.changed_modules }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Detect module changes
        id: changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "ğŸ”§ Manual workflow dispatch detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_modules=all" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ” Detecting module changes..."
          
          # ë¹„êµ ê¸°ì¤€ì  ê²°ì •: ë§ˆì§€ë§‰ ë¦´ë¦¬ì¦ˆ íƒœê·¸ ë˜ëŠ” main ë¸Œëœì¹˜
          current_branch="${{ github.ref_name }}"
          last_release_tag=$(git tag -l "release/android-v*" | grep -v -E "(alpha|beta|rc|patch|build)" | sort -V | tail -n1 2>/dev/null || echo "")
          
          if [ -n "$last_release_tag" ]; then
            compare_ref="$last_release_tag"
            echo "ğŸ“‹ Comparing with last release tag: $last_release_tag"
          elif [ "$current_branch" != "main" ]; then
            compare_ref="origin/main"
            echo "ğŸ“‹ No release tags found, comparing with main branch (current: $current_branch)"
          else
            compare_ref="HEAD~1"
            echo "ğŸ“‹ On main branch with no release tags, comparing with previous commit"
          fi
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ ê°ì§€
          echo "ğŸ”„ Running: git diff --name-only $compare_ref..HEAD"
          changed_files=$(git diff --name-only $compare_ref..HEAD 2>/dev/null || {
            echo "âš ï¸ Fallback to HEAD~1 comparison"
            git diff --name-only HEAD~1 HEAD
          })
          changed_modules=""
          
          echo "ğŸ“ Changed files:"
          echo "$changed_files" | while read -r file; do
            if [ -n "$file" ]; then
              echo "  - $file"
            fi
          done
          
          echo ""
          echo "ğŸ”„ Analyzing module changes..."
          
          if echo "$changed_files" | grep -q "^foundation/"; then
            echo "  âœ… Foundation module changed"
            changed_modules="$changed_modules,foundation"
          fi
          if echo "$changed_files" | grep -q "^core/"; then
            echo "  âœ… Core module changed"
            changed_modules="$changed_modules,core"
          fi
          if echo "$changed_files" | grep -q "^protocol/"; then
            echo "  âœ… Protocol module changed"
            changed_modules="$changed_modules,protocol"
          fi
          if echo "$changed_files" | grep -q "^product/"; then
            echo "  âœ… Product module changed"
            changed_modules="$changed_modules,product"
          fi
          
          # buildSrc ë³€ê²½ ê°ì§€
          if echo "$changed_files" | grep -q "^buildSrc/"; then
            echo "  âš™ï¸ Build configuration changed"
            changed_modules="$changed_modules,buildSrc"
          fi
          
          # ê¸°íƒ€ íŒŒì¼ ë³€ê²½ ê°ì§€
          other_files=$(echo "$changed_files" | grep -v -E "^(foundation|core|protocol|product|buildSrc)/" | head -5)
          if [ -n "$other_files" ]; then
            echo "  ğŸ“„ Other files changed:"
            echo "$other_files" | while read -r file; do
              if [ -n "$file" ]; then
                echo "    - $file"
              fi
            done
          fi
          
          if [ -n "$changed_modules" ]; then
            final_modules="${changed_modules#,}"
            echo ""
            echo "ğŸ¯ Final result: Changes detected in modules: $final_modules"
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "changed_modules=$final_modules" >> $GITHUB_OUTPUT
          else
            echo ""
            echo "â­ï¸ No module changes detected (documentation/config only)"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "changed_modules=" >> $GITHUB_OUTPUT
          fi

  # ë²„ì „ ê´€ë¦¬
  version-management:
    name: Version Management
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true'
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.version.outputs.should_deploy }}
      deploy_type: ${{ steps.version.outputs.deploy_type }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set repository URLs based on branch
        run: |
          if [[ "${{ github.ref_name }}" == ci/* ]]; then
            echo "NEXUS_RELEASE_URL=https://package.cross-nexus.com/repository/dev-cross-sdk-android/" >> $GITHUB_ENV
            echo "NEXUS_SNAPSHOT_URL=https://package.cross-nexus.com/repository/dev-cross-sdk-android-snap/" >> $GITHUB_ENV
            echo "ğŸŒ¿ CI branch detected - using dev repositories"
          else
            echo "NEXUS_RELEASE_URL=https://package.cross-nexus.com/repository/cross-sdk-android/" >> $GITHUB_ENV
            echo "NEXUS_SNAPSHOT_URL=https://package.cross-nexus.com/repository/cross-sdk-android-snap/" >> $GITHUB_ENV
            echo "ğŸŒ¿ Main branch detected - using production repositories"
          fi
          
      - name: Generate changeset
        env:
          NEXUS_RELEASE_URL: ${{ env.NEXUS_RELEASE_URL }}
          NEXUS_SNAPSHOT_URL: ${{ env.NEXUS_SNAPSHOT_URL }}
        run: |
          DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'snapshot' }}"
          VERSION_BUMP="${{ github.event.inputs.version_bump_type || 'none' }}"
          
          # í˜„ì¬ BOM ë²„ì „ ê°€ì ¸ì˜¤ê¸°
          CURRENT_BOM=$(grep "const val BOM_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          
          if [ "$VERSION_BUMP" != "none" ]; then
            echo "ğŸ“ Generating changeset for version bump..."
            
            # ë²„ì „ ë²”í”„ íƒ€ì…ì— ë”°ë¥¸ changeset íƒ€ì… ê²°ì •
            case "$VERSION_BUMP" in
              "release") CHANGESET_TYPE="minor" ;;
              "fix") CHANGESET_TYPE="patch" ;;
              "manual") CHANGESET_TYPE="minor" ;;
              *) CHANGESET_TYPE="patch" ;;
            esac
            
            ./gradlew autoChangeset -Pversion="$CURRENT_BOM" -Ptype="$CHANGESET_TYPE"
          fi

      - name: Handle version bumping
        id: version
        env:
          NEXUS_RELEASE_URL: ${{ env.NEXUS_RELEASE_URL }}
          NEXUS_SNAPSHOT_URL: ${{ env.NEXUS_SNAPSHOT_URL }}
        run: |
          DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'snapshot' }}"
          VERSION_BUMP="${{ github.event.inputs.version_bump_type || 'none' }}"
          MANUAL_VERSIONS="${{ github.event.inputs.manual_versions }}"
          CHANGED_MODULES="${{ needs.detect-changes.outputs.changed_modules }}"
          
          echo "ğŸ”„ Version management started..."
          echo "ğŸ“‹ Configuration:"
          echo "  - Deploy type: $DEPLOY_TYPE"
          echo "  - Version bump: $VERSION_BUMP"
          echo "  - Event: ${{ github.event_name }}"
          echo "  - Branch: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ¯ Changed modules from detection: $CHANGED_MODULES"
          
          # Main ë¸Œëœì¹˜ pushì‹œ ìë™ ë²„ì „ ë²”í”„ ë° ë°°í¬ íƒ€ì… ì„¤ì •
          if [ "${{ github.event_name }}" = "push" ]; then
            if [ "${{ github.ref_name }}" = "main" ]; then
              echo "ğŸš€ Main branch push detected - will deploy to both release and snapshot"
              DEPLOY_TYPE="both"
              
              if [ "$VERSION_BUMP" = "none" ] && [ -n "$CHANGED_MODULES" ]; then
                echo "ğŸ¤– Auto version bump detected for main branch push"
                
                # ì»¤ë°‹ ë©”ì‹œì§€ ë¶„ì„ìœ¼ë¡œ ë²”í”„ íƒ€ì… ê²°ì •
                LAST_COMMIT_MSG=$(git log -1 --pretty=%B)
                echo "Last commit: $LAST_COMMIT_MSG"
                
                if echo "$LAST_COMMIT_MSG" | grep -q "^feat\|BREAKING CHANGE"; then
                  AUTO_BUMP_TYPE="release"
                  echo "ğŸš€ Detected feature/breaking change â†’ minor bump"
                elif echo "$LAST_COMMIT_MSG" | grep -q "^fix\|^perf"; then
                  AUTO_BUMP_TYPE="fix"  
                  echo "ğŸ› Detected fix/perf â†’ patch bump"
                else
                  AUTO_BUMP_TYPE="fix"
                  echo "ğŸ“ Default â†’ patch bump"
                fi
                
                VERSION_BUMP="$AUTO_BUMP_TYPE"
                echo "ğŸ”„ Auto version bump type: $VERSION_BUMP"
              fi
            else
              echo "ğŸŒ¿ CI branch push detected - will deploy to snapshot only"
              DEPLOY_TYPE="snapshot"
            fi
          fi
          
          # ë²„ì „ ë²”í”„ ì‹¤í–‰
          if [ "$VERSION_BUMP" = "manual" ] && [ -n "$MANUAL_VERSIONS" ]; then
            echo "ğŸ“ Manual version bump: $MANUAL_VERSIONS"
            # ìˆ˜ë™ ë²„ì „ ì„¤ì • íŒŒì‹± ë° ì ìš©
            IFS=',' read -ra VERSIONS <<< "$MANUAL_VERSIONS"
            GRADLE_ARGS=""
            for version in "${VERSIONS[@]}"; do
              GRADLE_ARGS="$GRADLE_ARGS -P$version"
            done
            ./gradlew manualBump $GRADLE_ARGS
            
          elif [ "$VERSION_BUMP" = "fix" ]; then
            echo "ğŸ”§ Fix version bump"
            ./gradlew fixBump -Pmodules="${{ needs.detect-changes.outputs.changed_modules }}"
            
          elif [ "$VERSION_BUMP" = "release" ]; then
            echo "ğŸš€ Release version bump"  
            ./gradlew releaseBump -Pmodules="${{ needs.detect-changes.outputs.changed_modules }}"
            
          else
            echo "â­ï¸ No version bump requested"
          fi
          
          # ë³€ê²½ì‚¬í•­ì´ ìˆìœ¼ë©´ ì»¤ë°‹ (changesetê³¼ ë²„ì „ íŒŒì¼ ëª¨ë‘)
          if [ -n "$(git status --porcelain)" ]; then
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add buildSrc/src/main/kotlin/Versions.kt .changeset/
            git commit -m "chore: bump versions and generate changeset for $DEPLOY_TYPE deployment"
            git push
          fi
          
          echo "should_deploy=true" >> $GITHUB_OUTPUT
          echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT
          
          # í˜„ì¬ ë²„ì „ë“¤ ì¶œë ¥
          echo "ğŸ“‹ Updated versions:" 
          grep "const val.*_VERSION" buildSrc/src/main/kotlin/Versions.kt

  # ì‹¤ì œ ë°°í¬
  deploy:
    name: Deploy to Cross Nexus
    needs: [detect-changes, version-management]
    if: needs.version-management.outputs.should_deploy == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: main  # ë²„ì „ ë²”í”„ í›„ ìµœì‹  ìƒíƒœ
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true
        
      - name: Install Android SDK components
        run: sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          
      - name: Create local.properties
        run: echo "sdk.dir=$ANDROID_HOME" > local.properties

      - name: Create secrets.properties
        run: |
          cat > secrets.properties << EOF
          CROSS_FILENAME_UPLOAD=${{ vars.CROSS_FILENAME_UPLOAD }}
          CROSS_STORE_PASSWORD_UPLOAD=${{ secrets.CROSS_STORE_PASSWORD_UPLOAD }}
          CROSS_KEY_PASSWORD_UPLOAD=${{ secrets.CROSS_KEY_PASSWORD_UPLOAD }}
          CROSS_KEYSTORE_ALIAS=${{ vars.CROSS_KEYSTORE_ALIAS }}
          CROSS_FILENAME_INTERNAL=${{ vars.CROSS_FILENAME_INTERNAL }}
          CROSS_STORE_PASSWORD_INTERNAL=${{ secrets.CROSS_STORE_PASSWORD_INTERNAL }}
          CROSS_KEY_PASSWORD_INTERNAL=${{ secrets.CROSS_KEY_PASSWORD_INTERNAL }}
          CROSS_FILENAME_DEBUG=${{ vars.CROSS_FILENAME_DEBUG }}
          CROSS_STORE_PASSWORD_DEBUG=${{ secrets.CROSS_STORE_PASSWORD_DEBUG }}
          CROSS_KEY_PASSWORD_DEBUG=${{ secrets.CROSS_KEY_PASSWORD_DEBUG }}
          CROSS_KEYSTORE_ALIAS_DEBUG=${{ vars.CROSS_KEYSTORE_ALIAS_DEBUG }}
          CROSS_PROJECT_ID=${{ vars.CROSS_PROJECT_ID }}
          EOF

      - name: Read current versions
        id: versions
        run: |
          BOM_VER=$(grep "const val BOM_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          FOUNDATION_VER=$(grep "const val FOUNDATION_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          CORE_VER=$(grep "const val CORE_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          SIGN_VER=$(grep "const val SIGN_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          NOTIFY_VER=$(grep "const val NOTIFY_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          APPKIT_VER=$(grep "const val APPKIT_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          MODAL_CORE_VER=$(grep "const val MODAL_CORE_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          
          echo "bom_version=$BOM_VER" >> $GITHUB_OUTPUT
          echo "foundation_version=$FOUNDATION_VER" >> $GITHUB_OUTPUT
          echo "core_version=$CORE_VER" >> $GITHUB_OUTPUT
          echo "sign_version=$SIGN_VER" >> $GITHUB_OUTPUT
          echo "notify_version=$NOTIFY_VER" >> $GITHUB_OUTPUT
          echo "appkit_version=$APPKIT_VER" >> $GITHUB_OUTPUT
          echo "modal_core_version=$MODAL_CORE_VER" >> $GITHUB_OUTPUT

      - name: Set repository URLs based on branch
        id: repo_urls
        run: |
          if [[ "${{ github.ref_name }}" == ci/* ]]; then
            echo "NEXUS_RELEASE_URL=https://package.cross-nexus.com/repository/dev-cross-sdk-android/" >> $GITHUB_ENV
            echo "NEXUS_SNAPSHOT_URL=https://package.cross-nexus.com/repository/dev-cross-sdk-android-snap/" >> $GITHUB_ENV
            echo "ğŸŒ¿ CI branch detected - using dev repositories"
          else
            echo "NEXUS_RELEASE_URL=https://package.cross-nexus.com/repository/cross-sdk-android/" >> $GITHUB_ENV
            echo "NEXUS_SNAPSHOT_URL=https://package.cross-nexus.com/repository/cross-sdk-android-snap/" >> $GITHUB_ENV
            echo "ğŸŒ¿ Main branch detected - using production repositories"
          fi

      - name: Build modules
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          CROSS_PROJECT_ID: ${{ secrets.CROSS_PROJECT_ID }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          NEXUS_RELEASE_URL: ${{ env.NEXUS_RELEASE_URL }}
          NEXUS_SNAPSHOT_URL: ${{ env.NEXUS_SNAPSHOT_URL }}
        run: |
          echo "ğŸ”¨ Building modules in dependency order..."
          
          TARGET_MODULES="${{ github.event.inputs.target_modules }}"
          if [ -z "$TARGET_MODULES" ]; then
            # ì „ì²´ ëª¨ë“ˆ ë¹Œë“œ
            ./gradlew :foundation:publishToMavenLocal --no-daemon
            ./gradlew :core:android:publishToMavenLocal --no-daemon
            ./gradlew :core:modal:publishToMavenLocal --no-daemon
            ./gradlew :protocol:sign:publishToMavenLocal --no-daemon
            ./gradlew :protocol:notify:publishToMavenLocal --no-daemon
            ./gradlew :product:appkit:publishToMavenLocal --no-daemon
            ./gradlew :core:bom:publishToMavenLocal --no-daemon
          else
            # íŠ¹ì • ëª¨ë“ˆë§Œ ë¹Œë“œ
            IFS=',' read -ra MODULES <<< "$TARGET_MODULES"
            for module in "${MODULES[@]}"; do
              echo "Building module: $module"
              ./gradlew ":$module:publishToMavenLocal" --no-daemon
            done
          fi

      - name: Deploy to Cross Nexus
        if: ${{ github.event.inputs.dry_run != 'true' }}
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          CROSS_PROJECT_ID: ${{ secrets.CROSS_PROJECT_ID }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          NEXUS_RELEASE_URL: ${{ env.NEXUS_RELEASE_URL }}
          NEXUS_SNAPSHOT_URL: ${{ env.NEXUS_SNAPSHOT_URL }}
        run: |
          DEPLOY_TYPE="${{ needs.version-management.outputs.deploy_type }}"
          
          echo "ğŸš€ Deploying to Cross Nexus ($DEPLOY_TYPE)..."
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ“¦ Target repositories:"
          echo "  - Release: $NEXUS_RELEASE_URL"
          echo "  - Snapshot: $NEXUS_SNAPSHOT_URL"
          echo ""
          echo "ğŸ¯ Changed modules: ${{ needs.detect-changes.outputs.changed_modules }}"
          echo "ğŸ“‹ Deploy strategy:"
          if [ "${{ github.ref_name }}" = "main" ]; then
            echo "  - Main branch â†’ Both release and snapshot repositories"
          else
            echo "  - CI branch â†’ Snapshot repository only"
          fi
          echo ""
          echo "ğŸ“‹ Current versions:"
          echo "  BOM: ${{ steps.versions.outputs.bom_version }}"
          echo "  Foundation: ${{ steps.versions.outputs.foundation_version }}"
          echo "  Core: ${{ steps.versions.outputs.core_version }}"
          echo "  Sign: ${{ steps.versions.outputs.sign_version }}"
          echo "  Notify: ${{ steps.versions.outputs.notify_version }}"
          echo "  AppKit: ${{ steps.versions.outputs.appkit_version }}"
          echo "  Modal Core: ${{ steps.versions.outputs.modal_core_version }}"
          
          case "$DEPLOY_TYPE" in
            "release")
              ./gradlew deploy -Ptype=release
              ;;
            "snapshot")
              ./gradlew deploySnap -Ptype=snap
              ;;
            "both")
              ./gradlew deployBoth
              ;;
          esac

      - name: Determine Release Tag Strategy
        id: tag_strategy
        if: ${{ github.event.inputs.dry_run != 'true' && needs.version-management.outputs.deploy_type == 'release' }}
        run: |
          # ëª¨ë“  ëª¨ë“ˆ ë²„ì „ ì½ê¸°
          BOM_VER=$(grep "const val BOM_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          FOUNDATION_VER=$(grep "const val FOUNDATION_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          CORE_VER=$(grep "const val CORE_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          SIGN_VER=$(grep "const val SIGN_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          NOTIFY_VER=$(grep "const val NOTIFY_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          APPKIT_VER=$(grep "const val APPKIT_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          MODAL_CORE_VER=$(grep "const val MODAL_CORE_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          
          # ë³€ê²½ëœ ëª¨ë“ˆë“¤ í™•ì¸ (ë§ˆì§€ë§‰ ë¦´ë¦¬ì¦ˆ íƒœê·¸ì™€ ë¹„êµ)
          LAST_RELEASE_TAG=$(git tag -l "release/android-v*" | grep -v -E "(alpha|beta|rc)" | sort -V | tail -n1 2>/dev/null || echo "")
          
          if [ -n "$LAST_RELEASE_TAG" ]; then
            echo "ğŸ“‹ Comparing with last release: $LAST_RELEASE_TAG"
            
            # ë³€ê²½ëœ íŒŒì¼ë“¤ í™•ì¸
            CHANGED_FILES=$(git diff --name-only "$LAST_RELEASE_TAG"..HEAD -- foundation/ core/ protocol/ product/ buildSrc/src/main/kotlin/Versions.kt | head -20)
            echo "Changed files since last release:"
            echo "$CHANGED_FILES"
            
            # ë³€ê²½ëœ ëª¨ë“ˆ ê°ì§€
            CHANGED_MODULES=""
            if echo "$CHANGED_FILES" | grep -q "foundation/"; then
              CHANGED_MODULES="$CHANGED_MODULES,foundation:$FOUNDATION_VER"
            fi
            if echo "$CHANGED_FILES" | grep -q "core/"; then
              CHANGED_MODULES="$CHANGED_MODULES,core:$CORE_VER"
            fi
            if echo "$CHANGED_FILES" | grep -q "protocol/sign"; then
              CHANGED_MODULES="$CHANGED_MODULES,sign:$SIGN_VER"
            fi
            if echo "$CHANGED_FILES" | grep -q "protocol/notify"; then
              CHANGED_MODULES="$CHANGED_MODULES,notify:$NOTIFY_VER"
            fi
            if echo "$CHANGED_FILES" | grep -q "product/appkit"; then
              CHANGED_MODULES="$CHANGED_MODULES,appkit:$APPKIT_VER"
            fi
            if echo "$CHANGED_FILES" | grep -q "core/modal"; then
              CHANGED_MODULES="$CHANGED_MODULES,modal-core:$MODAL_CORE_VER"
            fi
            
            # BOM ë³€ê²½ í™•ì¸
            BOM_CHANGED=false
            if echo "$CHANGED_FILES" | grep -q "buildSrc/src/main/kotlin/Versions.kt"; then
              # Versions.ktê°€ ë³€ê²½ë˜ì—ˆê³  BOM_VERSIONì´ ì‹¤ì œë¡œ ë³€ê²½ë˜ì—ˆëŠ”ì§€ í™•ì¸
              OLD_BOM=$(git show "$LAST_RELEASE_TAG:buildSrc/src/main/kotlin/Versions.kt" | grep "const val BOM_VERSION" | sed 's/.*"\(.*\)".*/\1/' || echo "")
              if [ "$OLD_BOM" != "$BOM_VER" ]; then
                BOM_CHANGED=true
                CHANGED_MODULES="$CHANGED_MODULES,bom:$BOM_VER"
              fi
            fi
          else
            echo "ğŸ“‹ No previous release found, treating as initial release"
            BOM_CHANGED=true
            CHANGED_MODULES="foundation:$FOUNDATION_VER,core:$CORE_VER,sign:$SIGN_VER,notify:$NOTIFY_VER,appkit:$APPKIT_VER,modal-core:$MODAL_CORE_VER,bom:$BOM_VER"
          fi
          
          CHANGED_MODULES=$(echo "$CHANGED_MODULES" | sed 's/^,//')
          
          # íƒœê·¸ ì „ëµ ê²°ì •
          if [ "$BOM_CHANGED" = "true" ]; then
            # BOMì´ ë³€ê²½ëœ ê²½ìš°: BOM ë²„ì „ ê¸°ì¤€ íƒœê·¸
            TAG_VERSION="$BOM_VER"
            TAG_TYPE="bom"
            echo "ğŸ·ï¸ Using BOM-based tag (BOM changed): android-v${TAG_VERSION}"
          elif [ -n "$CHANGED_MODULES" ]; then
            # BOMì€ ë³€ê²½ë˜ì§€ ì•Šì•˜ì§€ë§Œ ê°œë³„ ëª¨ë“ˆì´ ë³€ê²½ëœ ê²½ìš°: ê°€ì¥ ë†’ì€ ë²„ì „ + íŒ¨ì¹˜
            HIGHEST_VER=$(echo "$CHANGED_MODULES" | tr ',' '\n' | cut -d':' -f2 | sort -V | tail -n1)
            # íŒ¨ì¹˜ ë²„ì „ ì¦ê°€ (ì˜ˆ: 1.0.1 â†’ 1.0.1-patch.1)
            TIMESTAMP=$(date +%Y%m%d%H%M)
            TAG_VERSION="${HIGHEST_VER}-patch.${TIMESTAMP}"
            TAG_TYPE="module"
            echo "ğŸ·ï¸ Using module-based tag (modules changed): android-v${TAG_VERSION}"
          else
            # ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°: í˜„ì¬ ì»¤ë°‹ í•´ì‹œ ê¸°ì¤€
            COMMIT_SHORT=$(git rev-parse --short HEAD)
            TAG_VERSION="${BOM_VER}-build.${COMMIT_SHORT}"
            TAG_TYPE="build"
            echo "ğŸ·ï¸ Using build-based tag (no changes): android-v${TAG_VERSION}"
          fi
          
          echo "tag_version=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "tag_type=$TAG_TYPE" >> $GITHUB_OUTPUT
          echo "changed_modules=$CHANGED_MODULES" >> $GITHUB_OUTPUT
          echo "bom_changed=$BOM_CHANGED" >> $GITHUB_OUTPUT

      - name: Create Git Release Tag
        if: ${{ github.event.inputs.dry_run != 'true' && needs.version-management.outputs.deploy_type == 'release' }}
        run: |
          TAG_VERSION="${{ steps.tag_strategy.outputs.tag_version }}"
          TAG_TYPE="${{ steps.tag_strategy.outputs.tag_type }}"
          CHANGED_MODULES="${{ steps.tag_strategy.outputs.changed_modules }}"
          BOM_CHANGED="${{ steps.tag_strategy.outputs.bom_changed }}"
          
          TAG="release/android-v${TAG_VERSION}"
          
          echo "ğŸ·ï¸ Creating release tag: $TAG (type: $TAG_TYPE)"
          
          # ê¸°ì¡´ íƒœê·¸ ì‚­ì œ (ìˆë‹¤ë©´)
          git tag -d "$TAG" 2>/dev/null || echo "Local tag $TAG not found"
          git push origin ":refs/tags/$TAG" 2>/dev/null || echo "Remote tag $TAG not found"
          
          # íƒœê·¸ ë©”ì‹œì§€ ìƒì„±
          case "$TAG_TYPE" in
            "bom")
              TAG_MESSAGE="Android SDK Release v${TAG_VERSION} (BOM Updated)

          ğŸ“¦ All Module Versions:"
              ;;
            "module")
              TAG_MESSAGE="Android SDK Patch Release v${TAG_VERSION} (Module Updates)

          ğŸ”„ Changed Modules: $CHANGED_MODULES
          ğŸ“¦ All Module Versions:"
              ;;
            "build")
              TAG_MESSAGE="Android SDK Build Release v${TAG_VERSION} (Build/CI Changes)

          ğŸ“¦ All Module Versions:"
              ;;
          esac
          
          # ìƒˆ íƒœê·¸ ìƒì„± ë° í‘¸ì‹œ
          git tag -a "$TAG" -m "$TAG_MESSAGE

          ğŸ“¦ Module Versions:
          - BOM: ${{ steps.versions.outputs.bom_version }}
          - Foundation: ${{ steps.versions.outputs.foundation_version }}
          - Core: ${{ steps.versions.outputs.core_version }}
          - Sign: ${{ steps.versions.outputs.sign_version }}
          - Notify: ${{ steps.versions.outputs.notify_version }}
          - AppKit: ${{ steps.versions.outputs.appkit_version }}
          - Modal Core: ${{ steps.versions.outputs.modal_core_version }}
          
          ğŸš€ Repository: ${{ github.ref_name == 'main' && 'https://package.cross-nexus.com/repository/cross-sdk-android/' || startsWith(github.ref_name, 'ci/') && 'https://package.cross-nexus.com/repository/dev-cross-sdk-android/' || 'https://package.cross-nexus.com/repository/cross-sdk-android/' }}"
          
          git push origin "$TAG"

      - name: Create GitHub Release
        if: ${{ github.event.inputs.dry_run != 'true' && needs.version-management.outputs.deploy_type == 'release' }}
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: release/android-v${{ steps.tag_strategy.outputs.tag_version }}
          release_name: Cross SDK Android v${{ steps.tag_strategy.outputs.tag_version }} (${{ steps.tag_strategy.outputs.tag_type == 'bom' && 'Full Release' || steps.tag_strategy.outputs.tag_type == 'module' && 'Module Update' || 'Build Release' }})
          body: |
            ## ğŸš€ Cross SDK Android Release v${{ steps.tag_strategy.outputs.tag_version }}
            
            ### ğŸ“‹ Release Information
            - **Release Type**: ${{ steps.tag_strategy.outputs.tag_type == 'bom' && 'ğŸ¯ Full Release (BOM Updated)' || steps.tag_strategy.outputs.tag_type == 'module' && 'ğŸ”„ Module Update' || 'ğŸ—ï¸ Build Release' }}
            - **Changed Modules**: ${{ steps.tag_strategy.outputs.changed_modules || 'Build/CI changes only' }}
            - **BOM Updated**: ${{ steps.tag_strategy.outputs.bom_changed == 'true' && 'Yes âœ…' || 'No â­ï¸' }}
            
            ### ğŸ“¦ Maven Dependencies
            
            **BOM (ê¶Œì¥):**
            ```kotlin
            implementation(platform("io.crosstoken:android-bom:${{ steps.versions.outputs.bom_version }}"))
            implementation("io.crosstoken:android-core")
            implementation("io.crosstoken:appkit")
            ```
            
            **ê°œë³„ ëª¨ë“ˆ:**
            ```kotlin
            implementation("io.crosstoken:foundation:${{ steps.versions.outputs.foundation_version }}")
            implementation("io.crosstoken:android-core:${{ steps.versions.outputs.core_version }}")
            implementation("io.crosstoken:sign:${{ steps.versions.outputs.sign_version }}")
            implementation("io.crosstoken:notify:${{ steps.versions.outputs.notify_version }}")
            implementation("io.crosstoken:appkit:${{ steps.versions.outputs.appkit_version }}")
            implementation("io.crosstoken:modal-core:${{ steps.versions.outputs.modal_core_version }}")
            ```
            
            ### ğŸ“‹ ëª¨ë“ˆë³„ ë²„ì „
            
            | ëª¨ë“ˆ | ë²„ì „ |
            |------|------|
            | BOM | ${{ steps.versions.outputs.bom_version }} |
            | Foundation | ${{ steps.versions.outputs.foundation_version }} |
            | Core Android | ${{ steps.versions.outputs.core_version }} |
            | Sign Protocol | ${{ steps.versions.outputs.sign_version }} |
            | Notify Protocol | ${{ steps.versions.outputs.notify_version }} |
            | AppKit | ${{ steps.versions.outputs.appkit_version }} |
            | Modal Core | ${{ steps.versions.outputs.modal_core_version }} |
            
            ### ğŸª Repository ì„¤ì •
            
            ```kotlin
            repositories {
                maven {
                    url = uri("${{ github.ref_name == 'main' && 'https://package.cross-nexus.com/repository/cross-sdk-android/' || startsWith(github.ref_name, 'ci/') && 'https://package.cross-nexus.com/repository/dev-cross-sdk-android/' || 'https://package.cross-nexus.com/repository/cross-sdk-android/' }}")
                }
            }
            ```
            
            ${{ startsWith(github.ref_name, 'ci/') && '> **âš ï¸ ê°œë°œ ë¸Œëœì¹˜ ë°°í¬**: ì´ ë¦´ë¦¬ì¦ˆëŠ” `ci/` ë¸Œëœì¹˜ì—ì„œ ë°°í¬ë˜ì–´ ê°œë°œìš© ë¦¬í¬ì§€í† ë¦¬ì— ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.' || '' }}
            
            ### ğŸ“– ë¬¸ì„œ
            - [SDK Documentation](README.md)
            - [API Reference](SDK-Documentation.md)
          draft: false
          prerelease: false

      - name: Dry run summary
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ğŸ§ª DRY RUN - ì‹¤ì œ ë°°í¬ëŠ” ìˆ˜í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
          echo "ë°°í¬ íƒ€ì…: ${{ needs.version-management.outputs.deploy_type }}"
          echo "ëŒ€ìƒ ëª¨ë“ˆ: ${{ github.event.inputs.target_modules || 'ì „ì²´' }}"

  # ë°°í¬ í›„ ì•Œë¦¼
  notify:
    name: Deployment Notification
    needs: [deploy]
    if: always() && needs.deploy.result != 'skipped'
    runs-on: ubuntu-latest
    steps:
      - name: Notify deployment result
        run: |
          if [ "${{ needs.deploy.result }}" = "success" ]; then
            echo "âœ… ë°°í¬ ì„±ê³µ!"
          else
            echo "âŒ ë°°í¬ ì‹¤íŒ¨!"
          fi
