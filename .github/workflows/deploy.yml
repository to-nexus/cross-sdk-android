name: Deploy SDK to Cross Nexus

on:
  push:
    tags:
      - 'sdk-v*'
      - 'sdk-snap-v*'
    branches:
      - develop
  workflow_dispatch:
    inputs:
      version:
        description: 'SDK version to deploy (e.g., 1.0.0)'
        required: true
        type: string
      deploy_type:
        description: 'Deployment type'
        required: true
        type: choice
        options:
          - release
          - snapshot
        default: release

permissions:
  id-token: write
  contents: write

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: [arc-runner-set]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  deploy:
    name: Deploy SDK to Cross Nexus
    needs: sonarqube
    runs-on: [arc-runner-set]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract version from tag
        id: extract_version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
            
            if [[ "$TAG_NAME" == sdk-snap-v* ]]; then
              # SNAPSHOT version (sdk-snap-v1.0.0 -> 1.0.0-SNAPSHOT)
              VERSION=$(echo $TAG_NAME | sed 's/^sdk-snap-v//')
              VERSION="${VERSION}-SNAPSHOT"
              DEPLOY_TYPE="snap"
              echo "is_snapshot=true" >> $GITHUB_OUTPUT
              echo "Deploying SNAPSHOT version: $VERSION"
            else
              # Release version (sdk-v1.0.0 -> 1.0.0)
              VERSION=$(echo $TAG_NAME | sed 's/^sdk-v//')
              DEPLOY_TYPE="release"
              echo "is_snapshot=false" >> $GITHUB_OUTPUT
              echo "Deploying RELEASE version: $VERSION"
            fi
            
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT
          else
            # Manual workflow dispatch
            DEPLOY_TYPE="${{ github.event.inputs.deploy_type || 'release' }}"
            VERSION="${{ github.event.inputs.version }}"
            
            if [ "$DEPLOY_TYPE" = "snapshot" ]; then
              VERSION="${VERSION}-SNAPSHOT"
              echo "is_snapshot=true" >> $GITHUB_OUTPUT
              echo "tag_name=sdk-snap-v${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
            else
              echo "is_snapshot=false" >> $GITHUB_OUTPUT
              echo "tag_name=sdk-v$VERSION" >> $GITHUB_OUTPUT
            fi
            
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "deploy_type=$DEPLOY_TYPE" >> $GITHUB_OUTPUT
          fi
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true
        
      - name: Install Android SDK components
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
          
      - name: Create local.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "Android SDK location: $ANDROID_HOME"

      - name: Create sample.keystore
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > keystore
          echo "keystore created from GitHub Secrets"

      - name: Create secrets.properties
        run: |
          cat > secrets.properties << EOF
          CROSS_FILENAME_UPLOAD=${{ vars.CROSS_FILENAME_UPLOAD }}
          CROSS_STORE_PASSWORD_UPLOAD=${{ secrets.CROSS_STORE_PASSWORD_UPLOAD }}
          CROSS_KEY_PASSWORD_UPLOAD=${{ secrets.CROSS_KEY_PASSWORD_UPLOAD }}
          CROSS_KEYSTORE_ALIAS=${{ vars.CROSS_KEYSTORE_ALIAS }}
          CROSS_FILENAME_INTERNAL=${{ vars.CROSS_FILENAME_INTERNAL }}
          CROSS_STORE_PASSWORD_INTERNAL=${{ secrets.CROSS_STORE_PASSWORD_INTERNAL }}
          CROSS_KEY_PASSWORD_INTERNAL=${{ secrets.CROSS_KEY_PASSWORD_INTERNAL }}
          CROSS_FILENAME_DEBUG=${{ vars.CROSS_FILENAME_DEBUG }}
          CROSS_STORE_PASSWORD_DEBUG=${{ secrets.CROSS_STORE_PASSWORD_DEBUG }}
          CROSS_KEY_PASSWORD_DEBUG=${{ secrets.CROSS_KEY_PASSWORD_DEBUG }}
          CROSS_KEYSTORE_ALIAS_DEBUG=${{ vars.CROSS_KEYSTORE_ALIAS_DEBUG }}
          CROSS_PROJECT_ID=${{ vars.CROSS_PROJECT_ID }}
          EOF
          echo "secrets.properties created from GitHub Secrets"

      - name: Read actual module versions
        id: read_versions
        run: |
          # Extract actual versions from Versions.kt
          BOM_VER=$(grep "const val BOM_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          FOUNDATION_VER=$(grep "const val FOUNDATION_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          CORE_VER=$(grep "const val CORE_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          SIGN_VER=$(grep "const val SIGN_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          NOTIFY_VER=$(grep "const val NOTIFY_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          APPKIT_VER=$(grep "const val APPKIT_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          MODAL_CORE_VER=$(grep "const val MODAL_CORE_VERSION" buildSrc/src/main/kotlin/Versions.kt | sed 's/.*"\(.*\)".*/\1/')
          
          echo "bom_version=$BOM_VER" >> $GITHUB_OUTPUT
          echo "foundation_version=$FOUNDATION_VER" >> $GITHUB_OUTPUT
          echo "core_version=$CORE_VER" >> $GITHUB_OUTPUT
          echo "sign_version=$SIGN_VER" >> $GITHUB_OUTPUT
          echo "notify_version=$NOTIFY_VER" >> $GITHUB_OUTPUT
          echo "appkit_version=$APPKIT_VER" >> $GITHUB_OUTPUT
          echo "modal_core_version=$MODAL_CORE_VER" >> $GITHUB_OUTPUT
          
          echo "üìã Module versions:"
          echo "BOM: $BOM_VER"
          echo "Foundation: $FOUNDATION_VER"
          echo "Core: $CORE_VER"
          echo "Sign: $SIGN_VER"
          echo "Notify: $NOTIFY_VER"
          echo "AppKit: $APPKIT_VER"
          echo "Modal Core: $MODAL_CORE_VER"

      - name: Build and publish dependencies to local repository
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          CROSS_PROJECT_ID: ${{ secrets.CROSS_PROJECT_ID }}
        run: |
          echo "üî® Building modules in dependency order..."
          
          # Check if signing is configured and set environment variables conditionally
          if [ -n "${{ secrets.SIGNING_KEY }}" ] && [ -n "${{ secrets.SIGNING_PASSWORD }}" ]; then
            echo "üîë Signing secrets configured - artifacts will be signed"
            export SIGNING_KEY="${{ secrets.SIGNING_KEY }}"
            export SIGNING_PASSWORD="${{ secrets.SIGNING_PASSWORD }}"
          else
            echo "‚ö†Ô∏è  Signing secrets not configured - artifacts will not be signed"
          fi
          
          # Build foundation first (no dependencies)
          echo "üì¶ Building foundation..."
          ./gradlew :foundation:publishToMavenLocal --no-daemon
          
          # Build core modules
          echo "üì¶ Building core:android..."
          ./gradlew :core:android:publishToMavenLocal --no-daemon
          
          echo "üì¶ Building core:modal..."
          ./gradlew :core:modal:publishToMavenLocal --no-daemon
          
          # Build protocol modules
          echo "üì¶ Building protocol:sign..."
          ./gradlew :protocol:sign:publishToMavenLocal --no-daemon
          
          echo "üì¶ Building protocol:notify..."
          ./gradlew :protocol:notify:publishToMavenLocal --no-daemon
          
          # Build product modules (depends on all above)
          echo "üì¶ Building product:appkit..."
          ./gradlew :product:appkit:publishToMavenLocal --no-daemon

          echo "üì¶ Building core:bom..."
          ./gradlew :core:bom:publishToMavenLocal --no-daemon
          
          echo "‚úÖ All modules built and published to local repository"

      - name: Build verification completed (develop branch)
        if: github.ref == 'refs/heads/develop'
        run: |
          echo "‚úÖ Build verification completed for develop branch"
          echo "üìã Built module versions:"
          echo "  BOM: ${{ steps.read_versions.outputs.bom_version }}"
          echo "  Foundation: ${{ steps.read_versions.outputs.foundation_version }}"
          echo "  Core: ${{ steps.read_versions.outputs.core_version }}"
          echo "  Sign: ${{ steps.read_versions.outputs.sign_version }}"
          echo "  Notify: ${{ steps.read_versions.outputs.notify_version }}"
          echo "  AppKit: ${{ steps.read_versions.outputs.appkit_version }}"
          echo "  Modal Core: ${{ steps.read_versions.outputs.modal_core_version }}"
          echo ""
          echo "‚ÑπÔ∏è  Skipping deployment - develop branch builds are for verification only"
          
      - name: Deploy to Cross Nexus
        if: startsWith(github.ref, 'refs/tags/') || github.event_name == 'workflow_dispatch'
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          CROSS_PROJECT_ID: ${{ secrets.CROSS_PROJECT_ID }}
        run: |
          DEPLOY_TYPE=${{ steps.extract_version.outputs.deploy_type }}
          TAG_VERSION=${{ steps.extract_version.outputs.version }}
          
          echo "üöÄ Deploying SDK modules from tag ${{ steps.extract_version.outputs.tag_name }}"
          echo "üìã Deployed module versions:"
          echo "  BOM: ${{ steps.read_versions.outputs.bom_version }}"
          echo "  Foundation: ${{ steps.read_versions.outputs.foundation_version }}"
          echo "  Core: ${{ steps.read_versions.outputs.core_version }}"
          echo "  Sign: ${{ steps.read_versions.outputs.sign_version }}"
          echo "  Notify: ${{ steps.read_versions.outputs.notify_version }}"
          echo "  AppKit: ${{ steps.read_versions.outputs.appkit_version }}"
          echo "  Modal Core: ${{ steps.read_versions.outputs.modal_core_version }}"
          echo ""
          
          if [ "$DEPLOY_TYPE" = "release" ]; then
            echo "üì¶ Deploying to Cross Nexus Release repository..."
          else
            echo "üì¶ Deploying to Cross Nexus Snapshot repository..."
          fi
          
          # Check if signing is configured and set environment variables conditionally
          if [ -n "${{ secrets.SIGNING_KEY }}" ] && [ -n "${{ secrets.SIGNING_PASSWORD }}" ]; then
            echo "üîë Setting up signing for deployment..."
            export SIGNING_KEY="${{ secrets.SIGNING_KEY }}"
            export SIGNING_PASSWORD="${{ secrets.SIGNING_PASSWORD }}"
          else
            echo "‚ö†Ô∏è  Deploying without signing..."
          fi
          
          # Deploy based on type
          if [ "$DEPLOY_TYPE" = "release" ]; then
            ./gradlew deploy -Ptype=release
          else
            ./gradlew deploySnap -Ptype=snap
          fi

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/') && steps.extract_version.outputs.is_snapshot == 'false'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_version.outputs.tag_name }}
          release_name: Cross SDK Android Release ${{ steps.extract_version.outputs.tag_name }}
          body: |
            ## Cross SDK Android Release ${{ steps.extract_version.outputs.tag_name }}
            
            ### üì¶ Deployed Artifacts (Release)
            
            **BOM (Recommended):**
            ```kotlin
            implementation(platform("io.crosstoken:android-bom:${{ steps.read_versions.outputs.bom_version }}"))
            ```
            
            **Individual Modules:**
            ```kotlin
            implementation("io.crosstoken:foundation:${{ steps.read_versions.outputs.foundation_version }}")
            implementation("io.crosstoken:android-core:${{ steps.read_versions.outputs.core_version }}")
            implementation("io.crosstoken:sign:${{ steps.read_versions.outputs.sign_version }}")
            implementation("io.crosstoken:notify:${{ steps.read_versions.outputs.notify_version }}")
            implementation("io.crosstoken:appkit:${{ steps.read_versions.outputs.appkit_version }}")
            implementation("io.crosstoken:modal-core:${{ steps.read_versions.outputs.modal_core_version }}")
            ```
            
            ### üìã Versions Per Modules
            
            | Module | Version |
            |------|------|
            | BOM | ${{ steps.read_versions.outputs.bom_version }} |
            | Foundation | ${{ steps.read_versions.outputs.foundation_version }} |
            | Core Android | ${{ steps.read_versions.outputs.core_version }} |
            | Sign | ${{ steps.read_versions.outputs.sign_version }} |
            | Notify | ${{ steps.read_versions.outputs.notify_version }} |
            | AppKit | ${{ steps.read_versions.outputs.appkit_version }} |
            | Modal Core | ${{ steps.read_versions.outputs.modal_core_version }} |
            
            ### üè™ Setup Repository
            
            ```kotlin
            repositories {
                maven {
                    url = uri("https://package.cross-nexus.com/repository/cross-sdk-android/")
                    credentials {
                        username = "your-nexus-username"
                        password = "your-nexus-password"
                    }
                }
            }
            ```
            
            ### üöÄ Deploying with a Tag
            
            ```bash
            # deploy release
            git tag -a "sdk-v1.0.0" -m "Release v1.0.0"
            git push origin sdk-v1.0.0
            
            # deploy snapshot
            git tag -a "sdk-snap-v1.0.0" -m "Snapshot v1.0.0"
            git push origin sdk-snap-v1.0.0
            ```
            
            ### üîß Deploying Local
            
            ```bash
            # deploy to release repository
            ./gradlew deploy -Ptype=release
            
            # deploy to snapshot repository (for development)
            ./gradlew deploySnap -Ptype=snap
            
            # deploy to both repositories
            ./gradlew deployBoth
            ```
            
            ### üìç Repository Address
            - **Release**: https://package.cross-nexus.com/repository/cross-sdk-android/
            - **Snapshot**: https://package.cross-nexus.com/repository/cross-sdk-android-snap/
          draft: false
          prerelease: false