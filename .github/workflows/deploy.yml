name: Deploy SDK to Cross Nexus

on:
  push:
    tags:
      - 'sdk-v*'
  pull_request:
    branches:
      - main
      - "ci/*"
  workflow_dispatch:
    inputs:
      version:
        description: 'SDK version to deploy (e.g., 1.0.0)'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  sonarqube:
    name: SonarQube Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: SonarQube Scan
        uses: SonarSource/sonarqube-scan-action@v5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  deploy:
    name: Deploy SDK to Cross Nexus
    # needs: sonarqube
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Extract version from tag
        id: extract_version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # Extract version from tag (sdk-v1.0.0 -> 1.0.0)
            VERSION=$(echo ${GITHUB_REF#refs/tags/sdk-v})
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            # Manual workflow dispatch
            VERSION="${{ github.event.inputs.version }}"
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "tag_name=sdk-v$VERSION" >> $GITHUB_OUTPUT
          fi
          echo "Deploying SDK version: $VERSION"
          
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        
      - name: Accept Android SDK licenses
        run: yes | sdkmanager --licenses || true
        
      - name: Install Android SDK components
        run: |
          sdkmanager "platform-tools" "platforms;android-34" "build-tools;34.0.0"
          
      - name: Cache Gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-
            
      - name: Update version in build files
        run: |
          VERSION=${{ steps.extract_version.outputs.version }}
          echo "Updating version to: $VERSION"
          
          # Update version in Versions.kt
          sed -i.bak "s/const val BOM_VERSION = \".*\"/const val BOM_VERSION = \"$VERSION\"/" buildSrc/src/main/kotlin/Versions.kt
          sed -i.bak "s/const val FOUNDATION_VERSION = \".*\"/const val FOUNDATION_VERSION = \"$VERSION\"/" buildSrc/src/main/kotlin/Versions.kt
          sed -i.bak "s/const val CORE_VERSION = \".*\"/const val CORE_VERSION = \"$VERSION\"/" buildSrc/src/main/kotlin/Versions.kt
          sed -i.bak "s/const val SIGN_VERSION = \".*\"/const val SIGN_VERSION = \"$VERSION\"/" buildSrc/src/main/kotlin/Versions.kt
          sed -i.bak "s/const val NOTIFY_VERSION = \".*\"/const val NOTIFY_VERSION = \"$VERSION\"/" buildSrc/src/main/kotlin/Versions.kt
          sed -i.bak "s/const val APPKIT_VERSION = \".*\"/const val APPKIT_VERSION = \"$VERSION\"/" buildSrc/src/main/kotlin/Versions.kt
          sed -i.bak "s/const val MODAL_CORE_VERSION = \".*\"/const val MODAL_CORE_VERSION = \"$VERSION\"/" buildSrc/src/main/kotlin/Versions.kt
          
          # Clean up backup files
          rm -f buildSrc/src/main/kotlin/Versions.kt.bak
          
      - name: Validate updated versions
        run: |
          echo "Updated versions in Versions.kt:"
          grep "_VERSION = " buildSrc/src/main/kotlin/Versions.kt
          
      - name: Create local.properties
        run: |
          echo "sdk.dir=$ANDROID_HOME" > local.properties
          echo "Android SDK location: $ANDROID_HOME"

      - name: Build and publish dependencies to local repository
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          echo "üî® Building modules in dependency order..."
          
          # Build foundation first (no dependencies)
          echo "üì¶ Building foundation..."
          ./gradlew :foundation:publishToMavenLocal --no-daemon
          
          # Build core modules
          echo "üì¶ Building core:android..."
          ./gradlew :core:android:publishToMavenLocal --no-daemon
          
          echo "üì¶ Building core:bom..."
          ./gradlew :core:bom:publishToMavenLocal --no-daemon
          
          echo "üì¶ Building core:modal..."
          ./gradlew :core:modal:publishToMavenLocal --no-daemon
          
          # Build protocol modules
          echo "üì¶ Building protocol:sign..."
          ./gradlew :protocol:sign:publishToMavenLocal --no-daemon
          
          echo "üì¶ Building protocol:notify..."
          ./gradlew :protocol:notify:publishToMavenLocal --no-daemon
          
          # Build product modules (depends on all above)
          echo "üì¶ Building product:appkit..."
          ./gradlew :product:appkit:publishToMavenLocal --no-daemon
          
          echo "‚úÖ All modules built and published to local repository"
          
      - name: Deploy to Cross Nexus
        env:
          NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
          NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
          SIGNING_KEY_ID: ${{ secrets.SIGNING_KEY_ID }}
          SIGNING_KEY: ${{ secrets.SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
        run: |
          echo "üöÄ Deploying SDK version ${{ steps.extract_version.outputs.version }} to Cross Nexus..."
          ./gradlew deployBoth --info --no-daemon
          
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.extract_version.outputs.tag_name }}
          release_name: Cross SDK Android v${{ steps.extract_version.outputs.version }}
          body: |
            ## Cross SDK Android v${{ steps.extract_version.outputs.version }}
            
            ### Î∞∞Ìè¨Îêú ÏïÑÌã∞Ìå©Ìä∏
            
            **BOM:**
            ```kotlin
            implementation(platform("io.crosstoken:android-bom:${{ steps.extract_version.outputs.version }}"))
            ```
            
            **Í∞úÎ≥Ñ Î™®Îìà:**
            ```kotlin
            implementation("io.crosstoken:foundation:${{ steps.extract_version.outputs.version }}")
            implementation("io.crosstoken:android-core:${{ steps.extract_version.outputs.version }}")
            implementation("io.crosstoken:sign:${{ steps.extract_version.outputs.version }}")
            implementation("io.crosstoken:notify:${{ steps.extract_version.outputs.version }}")
            implementation("io.crosstoken:appkit:${{ steps.extract_version.outputs.version }}")
            implementation("io.crosstoken:modal-core:${{ steps.extract_version.outputs.version }}")
            ```
            
            ### Î∞∞Ìè¨ Î∞©Î≤ï
            
            **Í∞ÑÎã®Ìïú Gradle Î™ÖÎ†πÏñ¥:**
            ```bash
            ./gradlew deploy -Ptype=release      # ReleaseÎßå
            ./gradlew deploySnap -Ptype=snap     # SnapshotÎßå  
            ./gradlew deployBoth                 # Îëò Îã§
            ```
            
            ### Ï†ÄÏû•ÏÜå
            - Release: https://package.cross-nexus.com/repository/cross-sdk-android/
            - Snapshot: https://package.cross-nexus.com/repository/cross-sdk-android-snap/
            
            ### ÏÇ¨Ïö©Î≤ï
            ```kotlin
            repositories {
                maven {
                    url = uri("https://package.cross-nexus.com/repository/cross-sdk-android/")
                    credentials {
                        username = "your-nexus-username"
                        password = "your-nexus-password"
                    }
                }
            }
            ```
          draft: false
          prerelease: false